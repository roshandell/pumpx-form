<script type="module">
import { Connection, clusterApiUrl, PublicKey } from "https://esm.sh/@solana/web3.js@1.95.3";
import { createMint, getOrCreateAssociatedTokenAccount, mintTo, TOKEN_PROGRAM_ID } from "https://esm.sh/@solana/spl-token@0.4.6?bundle";

const $ = id => document.getElementById(id);
const statusEl = $("status"), resultEl = $("result");
const connectBtn = $("connect"), createBtn = $("create"), netSel = $("network");

let provider = null, wallet = null, network = "devnet";
let connection = new Connection(clusterApiUrl(network), "confirmed");

// --- Provider detection (robust) ---
function getProvider() {
  const w = window;
  if (w?.phantom?.solana?.isPhantom) return w.phantom.solana;   // جدید
  if (w?.solana?.isPhantom)            return w.solana;          // قدیمی
  return null;
}
function setStatus(t){ statusEl.textContent = t || ""; }

// --- Open in Phantom app (mobile deep-link) ---
function phantomOpenLink(url){
  // مرورگرِ داخل اپ Phantom
  return `https://phantom.app/ul/browse?url=${encodeURIComponent(url)}`;
}
function showMobileHelp(){
  if ($("phantom-help")) return;
  const box = document.createElement("div");
  box.id = "phantom-help";
  box.className = "card";
  box.style.marginTop = "12px";
  box.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div>
        <div style="font-weight:700;margin-bottom:8px">اتصال موبایل</div>
        <div style="font-size:13px;opacity:.8">این صفحه را داخل اپ Phantom باز کن.</div>
        <div class="row" style="margin-top:8px">
          <a id="open-phantom" class="btn" target="_blank">Open in Phantom</a>
          <a class="btn" href="https://phantom.app/download" target="_blank">نصب Phantom</a>
        </div>
      </div>
    </div>`;
  document.querySelector(".wrap").appendChild(box);
  $("open-phantom").href = phantomOpenLink(location.href.split("#")[0]);
}

// --- UI wiring ---
netSel.addEventListener("change", e=>{
  network = e.target.value;
  connection = new Connection(clusterApiUrl(network), "confirmed");
});

async function tryConnect(onlyIfTrusted=false){
  provider = getProvider();
  if (!provider) {
    setStatus("Phantom شناسایی نشد.");
    // موبایل؟
    if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) showMobileHelp();
    return false;
  }
  try {
    const resp = await provider.connect( onlyIfTrusted ? { onlyIfTrusted:true } : {} );
    wallet = new PublicKey(resp.publicKey.toString());
    connectBtn.textContent = `متصل: ${wallet.toBase58().slice(0,4)}…${wallet.toBase58().slice(-4)}`;
    createBtn.disabled = false;
    setStatus("");
    const h = $("phantom-help"); if (h) h.remove();
    return true;
  } catch (e) {
    setStatus(e?.message || "اتصال لغو شد");
    return false;
  }
}

connectBtn.addEventListener("click", async ()=>{
  // دسکتاپ: اگر provider نیست، لینک نصب بده
  if (!getProvider() && !/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
    window.open("https://phantom.app/download", "_blank");
    return;
  }
  await tryConnect(false);
});

// پس از بازگشت از اپ، دوباره تلاش کند
document.addEventListener("visibilitychange", ()=>{
  if (document.visibilityState === "visible" && !wallet) tryConnect(true);
});

// در بارگذاری صفحه: اگر provider حاضر بود، بی‌صدا تست کن
window.addEventListener("load", async ()=>{
  await new Promise(r=>setTimeout(r, 300));
  await tryConnect(true);
  if (!getProvider() && /Mobi|Android|iPhone/i.test(navigator.userAgent)) showMobileHelp();
});

// --- Create token (مثل قبل) ---
createBtn.addEventListener("click", async ()=>{
  if (!wallet || !provider) return alert("ابتدا به Phantom وصل شوید.");
  const name = $("name").value.trim();
  const symbol = $("symbol").value.trim();
  const decimals = Math.max(0, Math.min(9, parseInt($("decimals").value||"9",10)));
  const supplyHuman = Number($("supply").value||"0");
  if (!(supplyHuman>0)) return alert("عرضه اولیه معتبر نیست.");

  try{
    setStatus("ایجاد Mint…");
    const signer = {
      publicKey: wallet,
      signTransaction: tx  => provider.signTransaction(tx),
      signAllTransactions: txs => provider.signAllTransactions(txs)
    };
    const mintPk = await createMint(connection, signer, wallet, wallet, decimals, undefined, undefined, TOKEN_PROGRAM_ID);

    setStatus("ساخت ATA…");
    const ata = await getOrCreateAssociatedTokenAccount(connection, signer, mintPk, wallet);

    setStatus("مینت عرضه اولیه…");
    const amount = Math.round(supplyHuman * 10**decimals);
    const sig = await mintTo(connection, signer, mintPk, ata.address, wallet, amount);

    setStatus("انجام شد ✅");
    const txUrl = `https://explorer.solana.com/tx/${sig}?cluster=${network==="devnet"?"devnet":""}`;
    const addrUrl = `https://explorer.solana.com/address/${mintPk.toBase58()}?cluster=${network==="devnet"?"devnet":""}`;
    resultEl.style.display = "block";
    resultEl.innerHTML = `
      <div>Mint: <code>${mintPk.toBase58()}</code></div>
      <div><a target="_blank" href="${addrUrl}">مشاهده Mint</a> • <a target="_blank" href="${txUrl}">تراکنش</a></div>`;
  }catch(e){
    console.error(e); setStatus("خطا"); alert(e?.message||e);
  }
});
</script>
