<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PumpX • Safe v2 (jsDelivr ESM + Error Overlay)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<style>
  :root{--bg:#0b0f1a;--card:#0f1524;--line:#334466;--accent:#79d9ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,"Noto Sans Arabic",sans-serif}
  a{color:var(--accent)}
  .wrap{max-width:1100px;margin:auto;padding:20px}
  .nav{position:sticky;top:0;background:#0b0f1acc;border-bottom:1px solid #ffffff22;backdrop-filter:blur(8px);z-index:50}
  .navin{display:flex;justify-content:space-between;align-items:center;height:64px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:#0f1524;border:1px solid #ffffff22;border-radius:16px;padding:16px;margin:12px 0}
  .btn{background:#1b2744;border:1px solid #445;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .input,.select,.textarea{background:#121a2c;border:1px solid #445;color:#fff;border-radius:12px;padding:10px 12px}
  .textarea{min-height:90px;resize:vertical}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .code{background:#0b0f1a;border:1px solid #445;border-radius:10px;padding:8px 10px;word-break:break-all}
  .muted{opacity:.8;font-size:13px}
  /* Error overlay */
  #err{position:fixed;inset:0;background:#000c;color:#fff;display:none;z-index:9999}
  #err .box{max-width:900px;margin:40px auto;background:#1a0f13;border:1px solid #ff4978;padding:16px;border-radius:12px}
  #err pre{white-space:pre-wrap;direction:ltr}
</style>
</head>
<body>
<div id="err"><div class="box">
  <div style="font-weight:800;color:#ff7aa6">JavaScript Error</div>
  <pre id="errmsg">...</pre>
  <button class="btn" onclick="location.reload()">Reload</button>
</div></div>

<div class="nav">
  <div class="wrap navin">
    <div class="row"><div style="font-weight:900;letter-spacing:.12em">PumpX</div><span class="muted">Safe v2</span></div>
    <div class="row">
      <select id="network" class="select">
        <option value="devnet" selected>Devnet</option>
        <option value="mainnet-beta">Mainnet</option>
      </select>
      <button id="connect" class="btn">اتصال کیف</button>
      <button id="disconnect" class="btn" style="display:none">قطع</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="row"><span class="muted">Provider:</span><span id="prov" class="code">—</span></div>
    <div class="row"><span class="muted">آدرس:</span><span id="addr" class="code">—</span></div>
    <div class="row"><span class="muted">موجودی SOL:</span><span id="bal" class="code">—</span></div>
    <div class="row"><span class="muted">RPC فعال:</span><span id="rpcUsing" class="code">—</span></div>
    <div id="https" class="muted"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px">ساخت توکن (SPL) + متادیتا (IPFS)</h2>
    <div class="grid">
      <label>نام<input id="name" class="input" value="PumpX Token"></label>
      <label>نماد<input id="symbol" class="input" value="PXPX"></label>
      <label>Decimals<input id="decimals" class="input" type="number" min="0" max="9" value="9"></label>
      <label>عرضه اولیه (واحد انسانی)<input id="supply" class="input" type="number" value="1000000000"></label>
      <label>آیکون (PNG/SVG/JPG)<input id="icon" class="input" type="file" accept=".png,.svg,.jpg,.jpeg"/></label>
      <label>NFT.Storage Token<input id="nftkey" class="input" placeholder="برای IPFS/متادیتا"/></label>
      <label style="grid-column:1/-1">توضیح/Story<textarea id="story" class="textarea"></textarea></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="createToken" class="btn" disabled>🪙 ساخت توکن</button>
      <button id="lock" class="btn" disabled>🔒 قفل Mint</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="result" class="card" style="display:none;margin-top:12px"></div>
  </div>
</div>

<script>
  // Error overlay
  (function(){
    const show = (msg)=>{
      document.getElementById('errmsg').textContent = msg;
      document.getElementById('err').style.display='block';
      console.error(msg);
    };
    window.addEventListener('error', e=> show('Error: '+(e.message||e.error||'unknown')), true);
    window.addEventListener('unhandledrejection', e=> show('Promise rejection: '+(e.reason?.message||e.reason||'unknown')), true);
  })();
</script>

<script type="module">
/* ===== فقط web3.js را از jsDelivr لود می‌کنیم ===== */
import { Connection, clusterApiUrl, PublicKey } from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/lib/index.browser.esm.js";

const $=id=>document.getElementById(id);
$("https").textContent = location.protocol.startsWith("https") ? "HTTPS: بله ✅" : "HTTPS: خیر ❌ — حتماً با HTTPS باز کنید.";

const HELIUS_MAINNET_URL="https://mainnet.helius-rpc.com/?api-key=b553d42b-55cd-48ca-bf99-e81ff18ef4d6";
const RPCS={
  "devnet":[clusterApiUrl("devnet"),"https://api.devnet.solana.com","https://devnet.rpcpool.com"],
  "mainnet-beta":[HELIUS_MAINNET_URL,clusterApiUrl("mainnet-beta"),"https://api.mainnet-beta.solana.com"]
};

let network="devnet";
let connection=new Connection(RPCS[network][0],"confirmed");
let provider=null, wallet=null;

const provEl=$("prov"),addrEl=$("addr"),balEl=$("bal"),rpcUsingEl=$("rpcUsing"),statusEl=$("status");
rpcUsingEl.textContent=RPCS[network][0];

function getProvider(){
  const w=window;
  if (w?.phantom?.solana?.isPhantom) return w.phantom.solana;
  if (w?.solana?.isPhantom) return w.solana;
  if (w?.solflare) return w.solflare;
  if (w?.solana?.isSolflare) return w.solana;
  return null;
}
async function tryBalance(url,pk){
  const conn=new Connection(url,"confirmed");
  rpcUsingEl.textContent=url;
  try{return await conn.getBalance(pk);}catch{const i=await conn.getAccountInfo(pk); return i?.lamports??0;}
}
async function safeBalance(pk){
  let last; for(const url of RPCS[network]){ try{ return await tryBalance(url,pk);}catch(e){last=e;} }
  throw last;
}
async function refreshBalance(){
  if(!wallet){ balEl.textContent="—"; return; }
  balEl.textContent="…";
  try{
    const lamports=await safeBalance(new PublicKey(wallet));
    balEl.textContent=(lamports/1e9).toFixed(6);
  }catch(e){ balEl.textContent="خطا"; }
}

$("network").onchange=async e=>{
  network=e.target.value;
  connection=new Connection(RPCS[network][0],"confirmed");
  rpcUsingEl.textContent=RPCS[network][0];
  await refreshBalance();
};

$("connect").onclick=async ()=>{
  provider=getProvider(); provEl.textContent=provider?"OK ✅":"Not found ❌";
  if(!provider){ alert("Phantom یا Solflare نصب/باز شود."); return; }
  try{
    const r=await (provider.connect?provider.connect():provider.request({method:"connect"}));
    wallet=r?.publicKey?.toString?.() || provider.publicKey?.toString?.();
    addrEl.textContent=wallet||"—";
    $("connect").style.display="none"; $("disconnect").style.display="inline-block";
    $("createToken").disabled=false;
    await refreshBalance();
  }catch(e){ statusEl.textContent=e?.message||e; }
};

$("disconnect").onclick=async ()=>{
  try{ await provider?.disconnect?.(); }catch{}
  wallet=null; addrEl.textContent="—"; balEl.textContent="—";
  $("connect").style.display="inline-block"; $("disconnect").style.display="none";
};

/* ===== کمک‌ها ===== */
async function uploadNFTStorage(blob,token){
  const r=await fetch("https://api.nft.storage/upload",{method:"POST",headers:{"Authorization":"Bearer "+token},body:blob});
  const j=await r.json(); if(!j.ok) throw new Error("NFT.Storage failed"); return "ipfs://"+j.value.cid;
}
function pumpxSVG(){
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='1024' height='1024' viewBox='0 0 1024 1024'>
    <rect width='1024' height='1024' fill='#0b0f1a'/>
    <g transform='translate(128,128)'><circle cx='384' cy='384' r='360' fill='none' stroke='#bfc7d6' stroke-width='24'/>
    <path d='M240 200h160c96 0 160 64 160 152s-64 152-160 152H320v120h-80V200z' fill='#3aa0ff'/>
    <path d='M320 336l56 56 92-92 44 44 84-84' fill='none' stroke='#2b74c8' stroke-width='24' stroke-linecap='round' stroke-linejoin='round'/>
    <path d='M260 680v-110l120-120' fill='none' stroke='#2b74c8' stroke-width='22' stroke-linecap='round'/></g></svg>`;
  return new Blob([svg],{type:"image/svg+xml"});
}

/* ===== Dynamic Imports از jsDelivr ===== */
const importSpl = ()=> import("https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.6/+esm");
const importUmiBundle = ()=> import("https://cdn.jsdelivr.net/npm/@metaplex-foundation/umi-bundle-defaults@0.8.10/+esm");
const importUmiCore = ()=> import("https://cdn.jsdelivr.net/npm/@metaplex-foundation/umi@0.8.10/+esm");
const importMplTM = ()=> import("https://cdn.jsdelivr.net/npm/@metaplex-foundation/mpl-token-metadata@3.1.2/+esm");

/* ===== ساخت توکن ===== */
$("createToken").onclick=async ()=>{
  if(!wallet||!provider) return alert("اول کیف را وصل کنید.");
  const name=$("name").value.trim(), symbol=$("symbol").value.trim();
  const decimals=Math.max(0,Math.min(9,parseInt($("decimals").value||"9",10)));
  const supplyHuman=Number($("supply").value||"0"); if(!(supplyHuman>0)) return alert("عرضه اولیه معتبر نیست.");
  const iconFile=$("icon").files[0]||null, nftKey=$("nftkey").value.trim(), story=$("story").value.trim();
  if(!nftKey) return alert("NFT.Storage token لازم است.");

  statusEl.textContent="بارگذاری ماژول‌ها…";
  const spl = await importSpl();
  const umiBundle = await importUmiBundle();
  const umiCore = await importUmiCore();
  const mplTM = await importMplTM();

  try{
    statusEl.textContent="آپلود آیکون/JSON…";
    const imageUri = await uploadNFTStorage(iconFile?iconFile:pumpxSVG(), nftKey);
    const meta = {
      name, symbol,
      description: story || `Token ${name} via PumpX`,
      image: imageUri, external_url: "https://pumpx.info",
      seller_fee_basis_points: 0,
      attributes: [{trait_type:"created_via",value:"PumpX"},{trait_type:"decimals",value:decimals}],
      properties: {category:"image", files:[{uri:imageUri,type: iconFile?iconFile.type:"image/svg+xml"}]}
    };
    const uri = await uploadNFTStorage(new Blob([JSON.stringify(meta)],{type:"application/json"}), nftKey);

    statusEl.textContent="ساخت Mint…";
    const signer={ publicKey:new PublicKey(wallet), signTransaction:(tx)=>provider.signTransaction(tx), signAllTransactions:(txs)=>provider.signAllTransactions(txs) };
    const mintPk=await spl.createMint(connection,signer,new PublicKey(wallet),new PublicKey(wallet),decimals,undefined,undefined,spl.TOKEN_PROGRAM_ID);

    statusEl.textContent="ساخت حساب توکن…";
    const ata=await spl.getOrCreateAssociatedTokenAccount(connection,signer,mintPk,new PublicKey(wallet));

    statusEl.textContent="مینت عرضه اولیه…";
    const amount=Math.round(supplyHuman*10**decimals);
    const sigMint=await spl.mintTo(connection,signer,mintPk,ata.address,new PublicKey(wallet),amount);

    statusEl.textContent="ثبت Metadata روی‌چین…";
    const umi=umiBundle.createUmi(RPCS[network][0]);
    umi.use(umiCore.signerIdentity({
      publicKey:umiCore.publicKey(wallet),
      signTransaction:async(tx)=>provider.signTransaction(tx),
      signAllTransactions:async(txs)=>provider.signAllTransactions(txs)
    }));
    await mplTM.createV1(umi,{
      mint:umiCore.publicKey(mintPk.toBase58()),
      authority:umiCore.publicKey(wallet),
      payer:umiCore.publicKey(wallet),
      updateAuthority:umiCore.publicKey(wallet),
      name,symbol,uri,sellerFeeBasisPoints:0
    }).sendAndConfirm(umi);

    const txUrl=`https://explorer.solana.com/tx/${sigMint}?cluster=${network==="devnet"?"devnet":""}`;
    const addrUrl=`https://explorer.solana.com/address/${mintPk.toBase58()}?cluster=${network==="devnet"?"devnet":""}`;
    const box=$("result"); box.style.display="block"; box.innerHTML=`
      <div><b>Mint:</b><div class="code">${mintPk.toBase58()}</div></div>
      <div><a target="_blank" href="${addrUrl}">Explorer</a> • <a target="_blank" href="${txUrl}">Transaction</a></div>`;
    statusEl.textContent="آماده ✅";
    $("lock").disabled=false;
    await refreshBalance();
  }catch(e){
    statusEl.textContent="خطا: "+(e?.message||e);
    console.error(e);
  }
};

/* ===== قفل Mint ===== */
$("lock").onclick=async ()=>{
  const text=$("result").textContent;
  const mintAddr=(text && text.match(/[1-9A-HJ-NP-Za-km-z]{32,44}/)?.[0])||"";
  if(!mintAddr||!wallet) return;
  const spl = await importSpl();
  try{
    statusEl.textContent="قفل کردن Mint…";
    const signer={ publicKey:new PublicKey(wallet), signTransaction:(tx)=>provider.signTransaction(tx), signAllTransactions:(txs)=>provider.signAllTransactions(txs) };
    await spl.setAuthority(connection,signer,new PublicKey(mintAddr),new PublicKey(wallet),spl.AuthorityType.MintTokens,null);
    statusEl.textContent="قفل شد 🔒";
  }catch(e){ statusEl.textContent="خطا: "+(e?.message||e); }
};

/* Auto-detect + silent connect */
window.addEventListener("load", async ()=>{
  const p=getProvider();
  $("prov").textContent = p ? "Detected ✅" : "Not found ❌";
  try{
    if(p){ const r=await p.connect?.({onlyIfTrusted:true}); if(r?.publicKey){ wallet=r.publicKey.toString(); $("addr").textContent=wallet; $("connect").style.display="none"; $("disconnect").style.display="inline-block"; $("createToken").disabled=false; await refreshBalance(); } }
  }catch{}
});
</script>
</body>
</html>
