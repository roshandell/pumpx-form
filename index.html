<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PumpX â€¢ AI Token Studio (Final + Debug)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<style>
  :root{--bg:#0b0f1a;--card:#0f1524;--line:#334466;--accent:#79d9ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,"Noto Sans Arabic",sans-serif}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1200px;margin:auto;padding:20px}
  .nav{position:sticky;top:0;background:#0b0f1acc;border-bottom:1px solid #ffffff22;backdrop-filter:blur(8px);z-index:50}
  .navin{display:flex;gap:10px;justify-content:space-between;align-items:center;height:64px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 14px;border-radius:12px;border:1px solid #ffffff22;background:#121a2c;cursor:pointer}
  .tab.active{background:#1b2744}
  .btn{background:#1b2744;border:1px solid #445;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .select,.input,.textarea{background:#121a2c;border:1px solid var(--line);color:#fff;border-radius:12px;padding:10px 12px}
  .textarea{min-height:90px;resize:vertical}
  .card{background:#0f1524;border:1px solid #ffffff22;border-radius:18px;padding:16px;margin:14px 0}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{opacity:.8;font-size:13px}
  .code{background:#0b0f1a;border:1px solid #445;border-radius:10px;padding:8px 10px;word-break:break-all}
  .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  @media(max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .kpi{background:#0f1524;border:1px solid #ffffff22;border-radius:16px;padding:12px}
  .card-sm{background:#10172a;border:1px solid #ffffff22;border-radius:14px;padding:12px}
  #err{position:fixed;inset:0;background:#000c;color:#fff;display:none;z-index:9999}
  #err .box{max-width:900px;margin:40px auto;background:#1a0f13;border:1px solid #ff4978;padding:16px;border-radius:12px}
  #err pre{white-space:pre-wrap;direction:ltr}
</style>
</head>
<body>
<!-- Error overlay -->
<div id="err"><div class="box">
  <div style="font-weight:800;color:#ff7aa6">JavaScript Error</div>
  <pre id="errmsg">...</pre>
  <button class="btn" onclick="location.reload()">Reload</button>
</div></div>
<script>
  const showErr=(m)=>{document.getElementById('errmsg').textContent=m;document.getElementById('err').style.display='block';console.error(m);};
  window.addEventListener('error',e=>showErr('Error: '+(e.message||e.error||'unknown')),true);
  window.addEventListener('unhandledrejection',e=>showErr('Promise rejection: '+(e.reason?.message||e.reason||'unknown')),true);
</script>
<script type="importmap">
{
  "imports": {
    "buffer": "https://cdn.jsdelivr.net/npm/buffer@6.0.3/+esm",
    "process": "https://cdn.jsdelivr.net/npm/process@0.11.10/+esm",
    "util": "https://cdn.jsdelivr.net/npm/util@0.12.5/+esm",
    "events": "https://cdn.jsdelivr.net/npm/events@3.3.0/+esm",
    "stream": "https://cdn.jsdelivr.net/npm/stream-browserify@3.0.0/+esm",
    "crypto": "https://cdn.jsdelivr.net/npm/crypto-browserify@3.12.0/+esm",

    "bn.js": "https://cdn.jsdelivr.net/npm/bn.js@5.2.1/+esm",
    "bs58": "https://cdn.jsdelivr.net/npm/bs58@5.0.0/+esm",
    "@solana/buffer-layout": "https://cdn.jsdelivr.net/npm/@solana/buffer-layout@4.0.1/+esm",
    "@solana/buffer-layout-utils": "https://cdn.jsdelivr.net/npm/@solana/buffer-layout-utils@1.2.0/+esm",

    "borsh": "https://cdn.jsdelivr.net/npm/borsh@0.7.0/lib/index.esm.js",

    "@noble/curves/ed25519": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/ed25519.js",
    "@noble/curves/ed448": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/ed448.js",
    "@noble/curves/secp256k1": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/secp256k1.js",
    "@noble/curves/abstract/weierstrass": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/abstract/weierstrass.js",
    "@noble/hashes/sha512": "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/sha512.js",
    "@noble/hashes/sha256": "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/sha256.js",
    "@noble/hashes/utils": "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/utils.js"
  }
}
</script>
<div class="nav">
  <div class="wrap navin">
    <div class="row"><div style="font-weight:900;letter-spacing:.12em">PumpX</div><span class="muted">AI Token Studio</span></div>
    <div class="row">
      <select id="network" class="select">
        <option value="devnet" selected>Devnet</option>
        <option value="mainnet-beta">Mainnet</option>
      </select>
      <button id="connect" class="btn">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ</button>
      <button id="disconnect" class="btn" style="display:none">Ù‚Ø·Ø¹</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="tabs">
    <div class="tab active" data-page="create">Ø³Ø§Ø®Øª ØªÙˆÚ©Ù†</div>
    <div class="tab" data-page="swap">Ø®Ø±ÛŒØ¯/ÙØ±ÙˆØ´</div>
    <div class="tab" data-page="ai">Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</div>
    <div class="tab" data-page="support">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</div>
  </div>

  <div class="kpis">
    <div class="kpi"><div class="muted">Provider</div><div id="prov" class="code">â€”</div></div>
    <div class="kpi"><div class="muted">Ø¢Ø¯Ø±Ø³</div><div id="addr" class="code">â€”</div></div>
    <div class="kpi"><div class="muted">Ù…ÙˆØ¬ÙˆØ¯ÛŒ SOL</div><div id="bal" class="code">â€”</div></div>
    <div class="kpi"><div class="muted">RPC ÙØ¹Ø§Ù„</div><div id="rpcUsing" class="code">â€”</div></div>
  </div>

  <!-- CREATE -->
  <section id="page-create" class="card">
    <h2 style="margin:0 0 10px">Ø³Ø§Ø®Øª ØªÙˆÚ©Ù† (SPL) + Ù…ØªØ§Ø¯ÛŒØªØ§ (IPFS)</h2>
    <div class="grid">
      <label>Ù†Ø§Ù…<input id="name" class="input" value="PumpX Token"></label>
      <label>Ù†Ù…Ø§Ø¯<input id="symbol" class="input" value="PXPX"></label>
      <label>Decimals<input id="decimals" class="input" type="number" min="0" max="9" value="9"></label>
      <label>Ø¹Ø±Ø¶Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ (ÙˆØ§Ø­Ø¯ Ø§Ù†Ø³Ø§Ù†ÛŒ)<input id="supply" class="input" type="number" value="1000000000"></label>
      <label>Ø¢ÛŒÚ©ÙˆÙ† (PNG/SVG/JPG)<input id="icon" class="input" type="file" accept=".png,.svg,.jpg,.jpeg"/></label>
      <label>NFT.Storage Token<input id="nftkey" class="input" placeholder="Ú©Ù„ÛŒØ¯ API Ø¨Ø±Ø§ÛŒ IPFS"/></label>
      <label style="grid-column:1/-1">ØªÙˆØ¶ÛŒØ­/Story<textarea id="story" class="textarea" placeholder="ÛŒÚ© Ø¬Ù…Ù„Ù‡ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø¯/Ø¬Ø§Ù…Ø¹Ù‡..."></textarea></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="createToken" class="btn" disabled>ğŸª™ Ø³Ø§Ø®Øª ØªÙˆÚ©Ù†</button>
      <button id="lock" class="btn" disabled>ğŸ”’ Ù‚ÙÙ„ Mint</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="result" class="card" style="display:none;margin-top:12px"></div>
  </section>

  <!-- SWAP -->
  <section id="page-swap" class="card" style="display:none">
    <h2 style="margin:0 0 10px">Ø®Ø±ÛŒØ¯/ÙØ±ÙˆØ´ â€” Jupiter</h2>
    <div class="card-sm" style="height:620px">
      <iframe id="jup" src="https://jup.ag/swap/SOL" style="width:100%;height:600px;border:0;border-radius:12px;background:#0b0f1a"></iframe>
    </div>
    <div class="row">
      <label style="flex:1">Ø¢Ø¯Ø±Ø³ Mint
        <input id="swapMint" class="input" placeholder="Mint address"/>
      </label>
      <button id="setSwap" class="btn">ØªÙ†Ø¸ÛŒÙ… SOL â†”ï¸ Token</button>
      <button id="setPXPX" class="btn">SOL â†”ï¸ PXPX</button>
    </div>
  </section>

  <!-- AI -->
  <section id="page-ai" class="card" style="display:none">
    <h2 style="margin:0 0 10px">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ PumpX</h2>
    <div class="grid">
      <label>OpenAI API Key (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)<input id="openai" class="input" placeholder="sk-..."></label>
      <label>ØªÙ…/Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§<input id="theme" class="input" value="Ù…ÛŒÙ…ØŒ Ø¬Ù‡Ø§Ù†ÛŒØŒ Ù†Ø¦ÙˆÙ†ÛŒ"></label>
      <label style="grid-column:1/-1">ØªÙˆØ¶ÛŒØ­/Ø±ÙˆØ¯Ù…Ù¾ Ù¾Ø±ÙˆÚ˜Ù‡<textarea id="desc" class="textarea"></textarea></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="aiBrand" class="btn">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù†Ø§Ù…/Ù†Ù…Ø§Ø¯/Story</button>
      <button id="aiRisk" class="btn">ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ³Ú©/Ø§Ø¹ØªÙ…Ø§Ø¯</button>
      <span id="aiStatus" class="muted"></span>
    </div>
    <div id="riskOut" class="card-sm" style="display:none;margin-top:10px"></div>
  </section>

  <!-- SUPPORT -->
  <section id="page-support" class="card" style="display:none">
    <h2 style="margin:0 0 10px">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</h2>
    <p>Ø§ÛŒÙ…ÛŒÙ„: <a href="mailto:support@pumpx.info">support@pumpx.info</a></p>
    <p class="muted">Ø³Ù„Ø¨ Ù…Ø³Ø¦ÙˆÙ„ÛŒØª: PumpX ÛŒÚ© Ø¨Ø³ØªØ± ÙÙ†ÛŒ Ø§Ø³Øª Ùˆ ÙˆØ¹Ø¯Ù‡ Ø³ÙˆØ¯ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>
  </section>
</div>

<!-- ImportMap: Ù¾Ù„ÛŒâ€ŒÙÛŒÙ„â€ŒÙ‡Ø§ÛŒ ESM Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± -->
<script type="importmap">
{
  "imports": {
    "buffer": "https://cdn.jsdelivr.net/npm/buffer@6.0.3/+esm",
    "process": "https://cdn.jsdelivr.net/npm/process@0.11.10/+esm",
    "util": "https://cdn.jsdelivr.net/npm/util@0.12.5/+esm",
    "events": "https://cdn.jsdelivr.net/npm/events@3.3.0/+esm",
    "stream": "https://cdn.jsdelivr.net/npm/stream-browserify@3.0.0/+esm",
    "crypto": "https://cdn.jsdelivr.net/npm/crypto-browserify@3.12.0/+esm",

    "bn.js": "https://cdn.jsdelivr.net/npm/bn.js@5.2.1/+esm",
    "bs58": "https://cdn.jsdelivr.net/npm/bs58@5.0.0/+esm",
    "@solana/buffer-layout": "https://cdn.jsdelivr.net/npm/@solana/buffer-layout@4.0.1/+esm",
    "@solana/buffer-layout-utils": "https://cdn.jsdelivr.net/npm/@solana/buffer-layout-utils@1.2.0/+esm",

    "@noble/curves/ed25519": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/ed25519.js",
    "@noble/curves/ed448": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/ed448.js",
    "@noble/curves/secp256k1": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/secp256k1.js",
    "@noble/curves/abstract/weierstrass": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/abstract/weierstrass.js",
    "@noble/hashes/sha512": "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/sha512.js",
    "@noble/hashes/sha256": "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/sha256.js",
    "@noble/hashes/utils": "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/utils.js"
  }
}
</script>

<script type="module">
/* ===== web3.js Ø§Ø² jsDelivr ===== */
import { Connection, clusterApiUrl, PublicKey } from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/lib/index.browser.esm.js";

/* ===== Ú©Ù…Ú©â€ŒÙ‡Ø§ÛŒ UI ===== */
const $=id=>document.getElementById(id);
document.querySelectorAll(".tab").forEach(t=>{t.onclick=()=>{document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));t.classList.add("active");const pg=t.dataset.page;document.querySelectorAll("section[id^='page-']").forEach(s=>s.style.display="none");$("page-"+pg).style.display="block";};});

/* ===== RPC Ù‡Ù„ÛŒÙˆØ³ (Ù¾Ù†Ù‡Ø§Ù†) + Ø³ÙˆØ¦ÛŒÚ†Ø± ===== */
const HELIUS_MAINNET_URL="https://mainnet.helius-rpc.com/?api-key=b553d42b-55cd-48ca-bf99-e81ff18ef4d6";
const RPCS={ "devnet":[clusterApiUrl("devnet"),"https://api.devnet.solana.com"], "mainnet-beta":[HELIUS_MAINNET_URL,clusterApiUrl("mainnet-beta"),"https://api.mainnet-beta.solana.com"] };
let network="devnet"; let connection=new Connection(RPCS[network][0],"confirmed");
const rpcUsingEl=$("rpcUsing"); rpcUsingEl.textContent=RPCS[network][0];

/* ===== Ú©ÛŒÙ Ù¾ÙˆÙ„ ===== */
let provider=null, wallet=null;
function getProvider(){const w=window; if(w?.phantom?.solana?.isPhantom) return w.phantom.solana; if(w?.solana?.isPhantom) return w.solana; if(w?.solflare) return w.solflare; if(w?.solana?.isSolflare) return w.solana; return null;}
const provEl=$("prov"),addrEl=$("addr"),balEl=$("bal"),statusEl=$("status");

/* ===== Ú†Ø±Ø§ Ø¯Ú©Ù…Ù‡ ØºÛŒØ±ÙØ¹Ø§Ù„Ù‡ØŸ (Ø¯ÛŒØ¨Ø§Ú¯) ===== */
function whyDisabled(){
  const reasons=[];
  if(!wallet) reasons.push("Ú©ÛŒÙ ÙˆØµÙ„ Ù†ÛŒØ³Øª");
  if(!$("nftkey").value.trim()) reasons.push("NFT.Storage Token Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");
  const btn=$("createToken");
  btn.disabled = reasons.length>0;
  statusEl.textContent = reasons.length?("ØºÛŒØ±ÙØ¹Ø§Ù„: "+reasons.join(" â€¢ ")): "Ø¢Ù…Ø§Ø¯Ù‡ âœ…";
}
$("nftkey").addEventListener("input", whyDisabled);

/* ===== Ù…ÙˆØ¬ÙˆØ¯ÛŒ ===== */
async function tryBalance(url,pk){const conn=new Connection(url,"confirmed"); rpcUsingEl.textContent=url; try{return await conn.getBalance(pk);}catch{const i=await conn.getAccountInfo(pk); return i?.lamports??0;}}
async function safeBalance(pk){let last; for(const url of RPCS[network]){try{return await tryBalance(url,pk);}catch(e){last=e;}} throw last;}
async function refreshBalance(){if(!wallet){balEl.textContent="â€”";return;} balEl.textContent="â€¦"; try{const lam=await safeBalance(new PublicKey(wallet)); balEl.textContent=(lam/1e9).toFixed(6);}catch{balEl.textContent="Ø®Ø·Ø§";}}

/* ===== Ø³ÙˆØ¦ÛŒÚ† Ø´Ø¨Ú©Ù‡ ===== */
$("network").onchange=async e=>{network=e.target.value; connection=new Connection(RPCS[network][0],"confirmed"); rpcUsingEl.textContent=RPCS[network][0]; await refreshBalance();};

/* ===== Ø§ØªØµØ§Ù„/Ù‚Ø·Ø¹ ===== */
$("connect").onclick=async()=>{
  provider=getProvider(); provEl.textContent=provider?"OK âœ…":"Not found âŒ";
  if(!provider){ alert("Phantom ÛŒØ§ Solflare Ù†ØµØ¨/Ø¨Ø§Ø² Ø´ÙˆØ¯."); return; }
  try{
    const r=await(provider.connect?provider.connect():provider.request({method:"connect"}));
    wallet=r?.publicKey?.toString?.()||provider.publicKey?.toString?.();
    addrEl.textContent=wallet||"â€”";
    $("connect").style.display="none"; $("disconnect").style.display="inline-block";
    await refreshBalance();
    whyDisabled();
  }catch(e){ statusEl.textContent=e?.message||e; }
};
$("disconnect").onclick=async()=>{
  try{ await provider?.disconnect?.(); }catch{}
  wallet=null; addrEl.textContent="â€”"; balEl.textContent="â€”";
  $("connect").style.display="inline-block"; $("disconnect").style.display="none";
  $("createToken").disabled=true;
  whyDisabled();
};

/* ===== IPFS helper + SVG ===== */
async function uploadNFTStorage(blob,token){const r=await fetch("https://api.nft.storage/upload",{method:"POST",headers:{"Authorization":"Bearer "+token},body:blob}); const j=await r.json(); if(!j.ok) throw new Error("NFT.Storage failed"); return "ipfs://"+j.value.cid;}
function pumpxSVG(){const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='1024' height='1024' viewBox='0 0 1024 1024'><rect width='1024' height='1024' fill='#0b0f1a'/><g transform='translate(128,128)'><circle cx='384' cy='384' r='360' fill='none' stroke='#bfc7d6' stroke-width='24'/><path d='M240 200h160c96 0 160 64 160 152s-64 152-160 152H320v120h-80V200z' fill='#3aa0ff'/><path d='M320 336l56 56 92-92 44 44 84-84' fill='none' stroke='#2b74c8' stroke-width='24' stroke-linecap='round' stroke-linejoin='round'/><path d='M260 680v-110l120-120' fill='none' stroke='#2b74c8' stroke-width='22' stroke-linecap='round'/></g></svg>`; return new Blob([svg],{type:"image/svg+xml"});}

/* ===== Dynamic Imports ===== */
const importSpl = ()=> import("https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.6/+esm");
const importUmiBundle = ()=> import("https://cdn.jsdelivr.net/npm/@metaplex-foundation/umi-bundle-defaults@0.8.10/+esm");
const importUmiCore = ()=> import("https://cdn.jsdelivr.net/npm/@metaplex-foundation/umi@0.8.10/+esm");
const importMplTM = ()=> import("https://cdn.jsdelivr.net/npm/@metaplex-foundation/mpl-token-metadata@3.1.2/+esm");

/* ===== Ø³Ø§Ø®Øª ØªÙˆÚ©Ù† ===== */
$("createToken").addEventListener("click", ()=>{
  if(!wallet) { alert("Ø§ÙˆÙ„ Ú©ÛŒÙ Ø±Ø§ ÙˆØµÙ„ Ú©Ù†ÛŒØ¯ âœ…"); return; }
});
$("createToken").onclick=async ()=>{
  if(!wallet||!provider) return;
  const name=$("name").value.trim(), symbol=$("symbol").value.trim();
  const decimals=Math.max(0,Math.min(9,parseInt($("decimals").value||"9",10)));
  const supplyHuman=Number($("supply").value||"0"); if(!(supplyHuman>0)) return alert("Ø¹Ø±Ø¶Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
  const iconFile=$("icon").files[0]||null, nftKey=$("nftkey").value.trim(), story=$("story").value.trim();
  if(!nftKey) return alert("NFT.Storage token Ù„Ø§Ø²Ù… Ø§Ø³Øª.");

  statusEl.textContent="Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§â€¦";
  const spl = await importSpl(), umiBundle = await importUmiBundle(), umiCore = await importUmiCore(), mplTM = await importMplTM();

  try{
    statusEl.textContent="Ø¢Ù¾Ù„ÙˆØ¯ Ø¢ÛŒÚ©ÙˆÙ†/JSONâ€¦";
    const imageUri = await uploadNFTStorage(iconFile?iconFile:pumpxSVG(), nftKey);
    const meta = { name, symbol, description: story || `Token ${name} via PumpX`, image: imageUri, external_url: "https://pumpx.info", seller_fee_basis_points: 0, attributes:[{trait_type:"created_via",value:"PumpX"},{trait_type:"decimals",value:decimals}], properties:{category:"image", files:[{uri:imageUri,type: iconFile?iconFile.type:"image/svg+xml"}]} };
    const uri = await uploadNFTStorage(new Blob([JSON.stringify(meta)],{type:"application/json"}), nftKey);

    statusEl.textContent="Ø³Ø§Ø®Øª Mintâ€¦";
    const signer={ publicKey:new PublicKey(wallet), signTransaction:(tx)=>provider.signTransaction(tx), signAllTransactions:(txs)=>provider.signAllTransactions(txs) };
    const mintPk=await spl.createMint(connection,signer,new PublicKey(wallet),new PublicKey(wallet),decimals,undefined,undefined,spl.TOKEN_PROGRAM_ID);

    statusEl.textContent="Ø³Ø§Ø®Øª Ø­Ø³Ø§Ø¨ ØªÙˆÚ©Ù†â€¦";
    const ata=await spl.getOrCreateAssociatedTokenAccount(connection,signer,mintPk,new PublicKey(wallet));

    statusEl.textContent="Ù…ÛŒÙ†Øª Ø¹Ø±Ø¶Ù‡ Ø§ÙˆÙ„ÛŒÙ‡â€¦";
    const amount=Math.round(supplyHuman*10**decimals);
    const sigMint=await spl.mintTo(connection,signer,mintPk,ata.address,new PublicKey(wallet),amount);

    statusEl.textContent="Ø«Ø¨Øª Metadata Ø±ÙˆÛŒâ€ŒÚ†ÛŒÙ†â€¦";
    const umi=umiBundle.createUmi(RPCS[network][0]);
    umi.use(umiCore.signerIdentity({ publicKey:umiCore.publicKey(wallet), signTransaction:async(tx)=>provider.signTransaction(tx), signAllTransactions:async(txs)=>provider.signAllTransactions(txs) }));
    await mplTM.createV1(umi,{ mint:umiCore.publicKey(mintPk.toBase58()),authority:umiCore.publicKey(wallet),payer:umiCore.publicKey(wallet),updateAuthority:umiCore.publicKey(wallet),name,symbol,uri,sellerFeeBasisPoints:0 }).sendAndConfirm(umi);

    const txUrl=`https://explorer.solana.com/tx/${sigMint}?cluster=${network==="devnet"?"devnet":""}`;
    const addrUrl=`https://explorer.solana.com/address/${mintPk.toBase58()}?cluster=${network==="devnet"?"devnet":""}`;
    const box=$("result"); box.style.display="block"; box.innerHTML=`
      <div><b>Mint:</b><div class="code">${mintPk.toBase58()}</div></div>
      <div><a target="_blank" href="${addrUrl}">Explorer</a> â€¢ <a target="_blank" href="${txUrl}">Transaction</a></div>`;
    statusEl.textContent="Ø¢Ù…Ø§Ø¯Ù‡ âœ…";
    $("lock").disabled=false;
    await refreshBalance();
  }catch(e){ statusEl.textContent="Ø®Ø·Ø§: "+(e?.message||e); console.error(e); }
};

/* ===== Ù‚ÙÙ„ Mint ===== */
$("lock").onclick=async ()=>{
  const text=$("result").textContent;
  const mintAddr=(text && text.match(/[1-9A-HJ-NP-Za-km-z]{32,44}/)?.[0])||"";
  if(!mintAddr||!wallet) return;
  const spl = await importSpl();
  try{
    statusEl.textContent="Ù‚ÙÙ„ Ú©Ø±Ø¯Ù† Mintâ€¦";
    const signer={ publicKey:new PublicKey(wallet), signTransaction:(tx)=>provider.signTransaction(tx), signAllTransactions:(txs)=>provider.signAllTransactions(txs) };
    await spl.setAuthority(connection,signer,new PublicKey(mintAddr),new PublicKey(wallet),spl.AuthorityType.MintTokens,null);
    statusEl.textContent="Ù‚ÙÙ„ Ø´Ø¯ ğŸ”’";
  }catch(e){ statusEl.textContent="Ø®Ø·Ø§: "+(e?.message||e); }
};

/* ===== Swap ===== */
$("setSwap").onclick=()=>{ const m=$("swapMint").value.trim(); if(m) $("jup").src=`https://jup.ag/swap/SOL-${m}`; };
$("setPXPX").onclick=()=>{$("jup").src="https://jup.ag/swap/SOL-PXPX";};

/* ===== AI ===== */
async function aiChat(key,prompt){
  if(!key){
    const seeds=["Nova","Flux","Neon","Astra","Pulse","Quark","Hyper","Glow","Vibe","Orbit"];
    const name=`${seeds[Math.random()*seeds.length|0]} Token`;
    const symbol=("PX"+(100+Math.random()*900|0)).slice(0,4).toUpperCase();
    const story=`${name}: ØªÙˆÚ©Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ø§Ù…Ø¹Ù‡â€ŒØ§ÛŒ Ù¾Ø±Ø§Ù†Ø±Ú˜ÛŒ Ø¨Ø§ ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ Ø±Ø´Ø¯ Ø³Ø§Ù„Ù….`;
    return {options:[{name,symbol,story}],warnings:["Ù‚ÙˆÙ„ Ø³ÙˆØ¯ Ù†Ø¯Ù‡ÛŒØ¯","Mint Ø±Ø§ Ù‚ÙÙ„ Ú©Ù†ÛŒØ¯","Ø´ÙØ§ÙÛŒØª Ø¯Ø± ØªÙˆÚ©Ù†ÙˆÙ…ÛŒÚ©Ø³"]};
  }
  const r=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"content-type":"application/json","authorization":"Bearer "+key},body:JSON.stringify({model:"gpt-4o-mini",temperature:0.8,messages:[{role:"system",content:"You are PumpX growth assistant. Return concise JSON only."},{role:"user",content:prompt}]})});
  const j=await r.json(); const txt=j?.choices?.[0]?.message?.content||"{}"; const m=txt.match(/\{[\s\S]*\}/);
  try{return JSON.parse(m?m[0]:txt);}catch{return {raw:txt};}
}
$("aiBrand").onclick=async()=>{ $("aiStatus").textContent="Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯â€¦"; const out=await aiChat($("openai").value.trim(),`Suggest 3 options: {name<=16, symbol=2-4 caps, story 1 sentence}. Theme: ${$("theme").value}. Return {"options":[...]}.`); const o=out?.options?.[0]||out; if(o?.name)$("name").value=o.name; if(o?.symbol)$("symbol").value=o.symbol; if(o?.story)$("story").value=o.story; $("aiStatus").textContent="Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯ âœ…"; };
$("aiRisk").onclick=async()=>{ $("aiStatus").textContent="ØªØ­Ù„ÛŒÙ„â€¦"; const out=await aiChat($("openai").value.trim(),`Analyze risks and trust-boosters for: ${$("desc").value||$("story").value}. Return {"warnings":["..."],"trust_boosters":["..."]}`); $("riskOut").style.display="block"; $("riskOut").innerHTML=`<div><b>Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</b><ul>${(out?.warnings||[]).map(x=>`<li>${x}</li>`).join("")||"<li>â€”</li>"}</ul></div><div><b>ØªÙ‚ÙˆÛŒØª Ø§Ø¹ØªÙ…Ø§Ø¯</b><ul>${(out?.trust_boosters||[]).map(x=>`<li>${x}</li>`).join("")||"<li>â€”</li>"}</ul></div>`; $("aiStatus").textContent="ØªÙ…Ø§Ù… âœ…"; };

/* ===== Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† SW/Ú©Ø´ Ù‚Ø¯ÛŒÙ…ÛŒ ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
  if (window.caches) caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
}

/* ===== Auto connect ===== */
window.addEventListener("load",async()=>{ const p=getProvider(); $("prov").textContent=p?"Detected âœ…":"Not found âŒ"; try{ if(p){const r=await p.connect?.({onlyIfTrusted:true}); if(r?.publicKey){ wallet=r.publicKey.toString(); $("addr").textContent=wallet; $("connect").style.display="none"; $("disconnect").style.display="inline-block"; await refreshBalance(); } } }catch{}; whyDisabled(); });
</script>
</body>
</html>
