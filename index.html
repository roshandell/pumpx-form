<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Solana Wallet Test – Phantom & Solflare (Final+Debug)</title>
<link rel="preconnect" href="https://esm.sh"/>
<style>
  :root{--bg:#0b0f1a;--card:#0f1524;--line:#334466}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,"Noto Sans Arabic",sans-serif}
  .wrap{max-width:820px;margin:auto;padding:22px}
  .card{background:#0f1524;border:1px solid #ffffff22;border-radius:16px;padding:16px;margin:12px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#1b2744;border:1px solid #445; color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  select,input{background:#121a2c;border:1px solid #445;color:#fff;border-radius:10px;padding:8px 10px}
  .code{background:#0b0f1a;border:1px solid #445;border-radius:10px;padding:8px 10px;word-break:break-all}
  .muted{opacity:.8;font-size:13px}
  a{color:#79d9ff}
</style>
</head>
<body>
<div class="wrap">
  <h1 style="margin:6px 0">تست کیف پول سولانا — Phantom / Solflare</h1>

  <!-- شبکه + RPC -->
  <div class="card">
    <div class="row">
      <label>شبکه:
        <select id="network">
          <option value="devnet" selected>Devnet</option>
          <option value="mainnet-beta">Mainnet</option>
        </select>
      </label>
      <label style="flex:1 1 360px">RPC Mainnet اختصاصی
        <input id="rpcMain" style="width:100%" placeholder="https://rpc.helius.xyz/?api-key=YOUR_KEY"/>
      </label>
      <span id="https" class="muted">HTTPS: —</span>
    </div>
    <div class="muted" style="margin-top:6px">
      برای Mainnet حتماً یک RPC اختصاصی (Helius/Alchemy/QuickNode/…) وارد کن تا خطای rate limit نگیری.
    </div>
  </div>

  <!-- اتصال -->
  <div class="card">
    <h3>اتصال</h3>
    <div class="row">
      <button id="connect-phantom" class="btn">اتصال Phantom</button>
      <button id="connect-solflare" class="btn">اتصال Solflare</button>
      <button id="disconnect" class="btn" disabled>قطع اتصال</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <!-- وضعیت -->
  <div class="card">
    <h3>وضعیت</h3>
    <div class="row"><span class="muted">Provider:</span> <span id="prov" class="code">—</span></div>
    <div class="row"><span class="muted">آدرس:</span> <span id="addr" class="code">—</span></div>
    <div class="row"><span class="muted">موجودی SOL:</span> <span id="bal" class="code">—</span></div>
    <div class="row"><span class="muted">RPC فعال:</span> <span id="rpcUsing" class="code">—</span></div>
    <div class="row"><span class="muted">خطای آخر:</span> <span id="lastErr" class="code">—</span></div>
    <div class="muted" style="margin-top:8px">
      Devnet: از <a href="https://faucet.solana.com" target="_blank">فاست سولانا</a> SOL بگیر.  
      اگر موجودی «خطا» شد، شبکهٔ کیف را با انتخاب بالا یکی کن؛ برای Mainnet یک RPC اختصاصی بده.
    </div>
  </div>
</div>

<script type="module">
import { Connection, clusterApiUrl, PublicKey } from "https://esm.sh/@solana/web3.js@1.95.3";

const $ = id => document.getElementById(id);
const netSel = $("network"), rpcMain = $("rpcMain");
const btnPhantom = $("connect-phantom"), btnSolflare = $("connect-solflare"), btnDisconnect = $("disconnect");
const statusEl = $("status"), provEl = $("prov"), addrEl = $("addr"), balEl = $("bal");
const rpcUsingEl = $("rpcUsing"), lastErrEl = $("lastErr");
$("https").textContent = location.protocol.startsWith("https") ? "HTTPS: بله ✅" : "HTTPS: خیر ❌";

let provider = null;
let walletPubkey = null;
let network = "devnet";

/* ---------- RPC ها ---------- */
const DEFAULT_RPCS = {
  "devnet": [
    clusterApiUrl("devnet"),
    "https://api.devnet.solana.com",
    "https://devnet.rpcpool.com"
  ],
  "mainnet-beta": [
    clusterApiUrl("mainnet-beta"),
    "https://api.mainnet-beta.solana.com",
    "https://rpc.ankr.com/solana"
  ]
};
function getRPCs(net){
  const custom = (net==="mainnet-beta" && rpcMain.value.trim())
    ? [rpcMain.value.trim()]
    : [];
  return [...custom, ...(DEFAULT_RPCS[net]||[])];
}
let connection = new Connection(getRPCs(network)[0], "confirmed");

/* ---------- Helpers ---------- */
const setStatus = (t)=> statusEl.textContent = t || "";
const short = (pk)=> pk ? pk.slice(0,4)+"…"+pk.slice(-4) : "—";
const getPhantomProvider = ()=>{
  const w = window;
  if (w?.phantom?.solana?.isPhantom) return w.phantom.solana;
  if (w?.solana?.isPhantom) return w.solana;
  return null;
};
const getSolflareProvider = ()=>{
  const w = window;
  if (w?.solflare) return w.solflare;
  if (w?.solana?.isSolflare) return w.solana;
  return null;
};
function showProviderName(p){
  if(!p){ provEl.textContent = "پیدا نشد ❌"; return; }
  if (p === getPhantomProvider()) provEl.textContent = "Phantom ✅";
  else if (p === getSolflareProvider()) provEl.textContent = "Solflare ✅";
  else provEl.textContent = "نامشخص/سازگار ✅";
}

/* ---------- خواندن موجودی با فالبک + گزارش ---------- */
async function tryBalanceFrom(url, pubkey){
  const conn = new Connection(url, "confirmed");
  rpcUsingEl.textContent = url;
  // تست 1: getBalance
  try {
    const lamports = await conn.getBalance(new PublicKey(pubkey));
    return { ok:true, lamports };
  } catch (e1) {
    // تست 2: getAccountInfo (برای تشخیص CORS/Rate-limit)
    try {
      const info = await conn.getAccountInfo(new PublicKey(pubkey));
      if (info) return { ok:true, lamports: info.lamports ?? 0 };
      return { ok:true, lamports: 0 }; // اکانت وجود ندارد => 0
    } catch (e2) {
      throw new Error(`(${url}) ${e2?.message || e2}`);
    }
  }
}
async function safeGetBalance(pubkeyBase58, net){
  lastErrEl.textContent = "—";
  const urls = getRPCs(net);
  let lastErr = null;
  for (const url of urls) {
    try {
      const res = await tryBalanceFrom(url, pubkeyBase58);
      if (res.ok) return res.lamports;
    } catch (e) {
      lastErr = e;
      lastErrEl.textContent = String(e);
      // بعدی را امتحان کن
    }
  }
  throw lastErr || new Error("هیچ RPC در دسترس نیست");
}
async function refreshBalance(){
  if(!walletPubkey){ balEl.textContent="—"; return; }
  balEl.textContent="…";
  try{
    const lamports = await safeGetBalance(walletPubkey, network);
    balEl.textContent = (lamports/1e9).toFixed(6);
    setStatus("");
  }catch(e){
    balEl.textContent = "خطا";
    lastErrEl.textContent = String(e);
    const msg = String(e).toLowerCase();
    setStatus(
      msg.includes("429") || msg.includes("rate")
        ? "RPC شلوغ/ریملیت؛ لطفاً RPC اختصاصی وارد کن."
        : "RPC عمومی پاسخ نداد؛ یک RPC اختصاصی برای Mainnet وارد کن."
    );
  }
}

/* ---------- رویدادها ---------- */
netSel.addEventListener("change", async e=>{
  network = e.target.value;
  connection = new Connection(getRPCs(network)[0], "confirmed");
  await refreshBalance();
});
rpcMain.addEventListener("change", ()=>{
  if (network==="mainnet-beta") connection = new Connection(getRPCs(network)[0], "confirmed");
});

/* ---------- اتصال/قطع ---------- */
async function connectWith(p){
  if(!p){ setStatus("Provider یافت نشد."); showProviderName(null); return; }
  provider = p; showProviderName(provider);
  try{
    const resp = await (provider.connect ? provider.connect() : provider.request({method:"connect"}));
    const pk = resp?.publicKey?.toString?.() || provider.publicKey?.toString?.();
    if(!pk) throw new Error("PublicKey برنگشت.");
    walletPubkey = pk;
    addrEl.textContent = pk;
    setStatus("متصل شد: "+short(pk));
    btnDisconnect.disabled = false;
    await refreshBalance();
  }catch(e){
    setStatus("خطا/لغو اتصال: "+(e?.message||e));
    console.error(e);
  }
}
async function disconnect(){
  try{ await provider?.disconnect?.(); }catch{}
  walletPubkey=null; addrEl.textContent="—"; balEl.textContent="—";
  btnDisconnect.disabled=true; setStatus("قطع شد");
}

/* ---------- دکمه‌ها ---------- */
btnPhantom.addEventListener("click", ()=>connectWith(getPhantomProvider()));
btnSolflare.addEventListener("click", ()=>connectWith(getSolflareProvider()));
btnDisconnect.addEventListener("click", disconnect);

/* ---------- اطلاعات اولیه ---------- */
window.addEventListener("load", ()=>{
  const p1 = !!getPhantomProvider();
  const p2 = !!getSolflareProvider();
  provEl.textContent = (p1? "Phantom✅ " : "Phantom❌ ") + "| " + (p2? "Solflare✅" : "Solflare❌");
});
</script>
</body>
</html>
