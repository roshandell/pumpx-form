<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PumpX • Token Creator</title>
  <style>
    body{margin:0;background:#0d1117;color:#fff;font-family:Inter,system-ui,"Noto Sans Arabic",sans-serif}
    .wrap{max-width:900px;margin:auto;padding:24px}
    h1{margin:0 0 16px}
    .card{background:#161b22;border:1px solid #2b3542;border-radius:16px;padding:18px;margin-top:16px}
    label{display:block;margin:8px 0 4px;opacity:.9}
    input,select,textarea,button{width:100%;border-radius:10px;border:1px solid #2b3542;background:#0f1520;color:#fff;padding:10px}
    button{cursor:pointer;background:#238636;border:none}
    button:hover{background:#2ea043}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .half{flex:1 1 300px}
    .muted{opacity:.8}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .kpis .card{padding:12px}
    .code{word-break:break-all;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1118;border:1px solid #2b3542;border-radius:8px;padding:8px}
    #err{position:fixed;inset:0;background:#000c;display:none}
    #err .box{max-width:900px;margin:40px auto;background:#1a0f13;border:1px solid #ff5577;padding:16px;border-radius:12px;color:#fff}
    #err pre{white-space:pre-wrap;direction:ltr}
  </style>

  <!-- ImportMap -->
  <script type="importmap">
  {
    "imports": {
      "buffer": "https://cdn.jsdelivr.net/npm/buffer@6.0.3/+esm",
      "process": "https://cdn.jsdelivr.net/npm/process@0.11.10/+esm",
      "util": "https://cdn.jsdelivr.net/npm/util@0.12.5/+esm",
      "events": "https://cdn.jsdelivr.net/npm/events@3.3.0/+esm",
      "stream": "https://cdn.jsdelivr.net/npm/stream-browserify@3.0.0/+esm",
      "crypto": "https://cdn.jsdelivr.net/npm/crypto-browserify@3.12.0/+esm",

      "bn.js": "https://cdn.jsdelivr.net/npm/bn.js@5.2.1/+esm",
      "bs58": "https://cdn.jsdelivr.net/npm/bs58@5.0.0/+esm",
      "@solana/buffer-layout": "https://cdn.jsdelivr.net/npm/@solana/buffer-layout@4.0.1/+esm",
      "@solana/buffer-layout-utils": "https://cdn.jsdelivr.net/npm/@solana/buffer-layout-utils@1.2.0/+esm",
      "borsh": "https://cdn.jsdelivr.net/npm/borsh@0.7.0/lib/index.esm.js",

      "@noble/curves/ed25519": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/ed25519.js",
      "@noble/curves/ed448": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/ed448.js",
      "@noble/curves/secp256k1": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/secp256k1.js",
      "@noble/curves/abstract/weierstrass": "https://cdn.jsdelivr.net/npm/@noble/curves@1.2.0/abstract/weierstrass.js",
      "@noble/hashes/sha512": "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/sha512.js",
      "@noble/hashes/sha256": "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/sha256.js",
      "@noble/hashes/utils": "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/utils.js",

      "bigint-buffer": "https://esm.sh/bigint-buffer@1.1.5?target=es2020&bundle",
      "safe-buffer": "https://cdn.jsdelivr.net/npm/safe-buffer@5.2.1/+esm",
      "ieee754": "https://cdn.jsdelivr.net/npm/ieee754@1.2.1/+esm",

      "superstruct": "https://esm.sh/superstruct@1.0.3?target=es2020&bundle"
    }
  }
  </script>
</head>
<body>
<div id="err"><div class="box">
  <div style="font-weight:800;color:#ff90a0;margin-bottom:8px">JavaScript Error</div>
  <pre id="errmsg">...</pre>
  <button onclick="location.reload()">Reload</button>
</div></div>
<script>
  const showErr=(m)=>{document.getElementById('errmsg').textContent=m;document.getElementById('err').style.display='block';console.error(m);};
  window.addEventListener('error',e=>showErr('Error: '+(e.message||e.error||'unknown')),true);
  window.addEventListener('unhandledrejection',e=>showErr('Promise rejection: '+(e.reason?.message||e.reason||'unknown')),true);
</script>

<div class="wrap">
  <h1>🚀 PumpX Token Creator</h1>

  <div class="row">
    <div class="half">
      <label>شبکه</label>
      <select id="network">
        <option value="devnet">Devnet</option>
        <option value="mainnet-beta">Mainnet</option>
      </select>
    </div>
    <div class="half">
      <label>کیف پول</label>
      <select id="walletSel">
        <option value="phantom">Phantom</option>
        <option value="solflare">Solflare</option>
      </select>
    </div>
  </div>

  <div class="row">
    <button id="connect" class="half">اتصال کیف</button>
    <button id="disconnect" class="half" style="background:#444">قطع اتصال</button>
  </div>

  <div class="kpis">
    <div class="card"><div class="muted">Provider</div><div id="prov" class="code">—</div></div>
    <div class="card"><div class="muted">آدرس</div><div id="addr" class="code">—</div></div>
    <div class="card"><div class="muted">موجودی SOL</div><div id="bal" class="code">—</div></div>
    <div class="card"><div class="muted">RPC</div><div id="rpcUsing" class="code">—</div></div>
  </div>

  <div class="card">
    <div class="row">
      <div class="half">
        <label>نام توکن</label><input id="name" value="PumpX Token"/>
      </div>
      <div class="half">
        <label>نماد</label><input id="symbol" value="PXPX"/>
      </div>
    </div>
    <div class="row">
      <div class="half">
        <label>Decimals</label><input id="decimals" type="number" value="9" min="0" max="9"/>
      </div>
      <div class="half">
        <label>عرضه اولیه (واحد انسانی)</label><input id="supply" type="number" value="1000000000"/>
      </div>
    </div>
    <button id="create">🪙 ایجاد توکن SPL</button>
    <div id="status" class="muted" style="margin-top:8px"></div>
    <div id="out" class="card" style="display:none;margin-top:12px"></div>
  </div>
</div>

<script type="module">
import { Connection, clusterApiUrl, PublicKey } from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/lib/index.browser.esm.js";
import * as spl from "https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.6/+esm";

const HELIUS = "https://mainnet.helius-rpc.com/?api-key=b553d42b-55cd-48ca-bf99-e81ff18ef4d6";
const RPCS = {
  "devnet": [clusterApiUrl("devnet"), "https://api.devnet.solana.com"],
  "mainnet-beta": [HELIUS, clusterApiUrl("mainnet-beta"), "https://api.mainnet-beta.solana.com"]
};

const $ = id => document.getElementById(id);
const provEl = $("prov"), addrEl=$("addr"), balEl=$("bal"), status=$("status"), out=$("out"), rpcEl=$("rpcUsing");

let network = $("network").value;
let connection = new Connection(RPCS[network][0], "confirmed");
rpcEl.textContent = RPCS[network][0];

let provider=null, wallet=null;

$("network").onchange = async (e) => {
  network = e.target.value;
  connection = new Connection(RPCS[network][0], "confirmed");
  rpcEl.textContent = RPCS[network][0];
  await refreshBalance();
};

function getProvider() {
  const w=window;
  const sel = $("walletSel").value;
  if (sel==="phantom") {
    if (w?.phantom?.solana?.isPhantom) return w.phantom.solana;
    if (w?.solana?.isPhantom) return w.solana;
  } else {
    if (w?.solflare?.isSolflare) return w.solflare;
    if (w?.solana?.isSolflare) return w.solana;
  }
  return null;
}

$("connect").onclick = async () => {
  provider = getProvider();
  provEl.textContent = provider ? "Detected ✅" : "Not found ❌";
  if (!provider) { alert("افزونه انتخاب‌شده نصب/باز نیست."); return; }
  try {
    const r = await (provider.connect ? provider.connect() : provider.request({method:"connect"}));
    wallet = (r?.publicKey?.toString?.()) || provider.publicKey?.toString?.();
    addrEl.textContent = wallet || "—";
    await refreshBalance();
    status.textContent = "آماده ✅";
  } catch (e) { status.textContent="خطا: "+(e?.message||e); }
};

$("disconnect").onclick = async () => {
  try{ await provider?.disconnect?.(); }catch{}
  wallet=null; addrEl.textContent="—"; balEl.textContent="—";
};

async function tryBalance(url,pk) {
  const c = new Connection(url, "confirmed"); rpcEl.textContent = url;
  try { return await c.getBalance(pk); }
  catch { const info = await c.getAccountInfo(pk); return info?.lamports ?? 0; }
}
async function safeBalance(pk){
  let last; for (const url of RPCS[network]) {
    try { return await tryBalance(url,pk); } catch(e){ last=e; }
  } throw last;
}
async function refreshBalance(){
  if (!wallet) { balEl.textContent="—"; return; }
  balEl.textContent = "…";
  try {
    const lam = await safeBalance(new PublicKey(wallet));
    balEl.textContent = (lam/1e9).toFixed(6);
  } catch { balEl.textContent="خطا"; }
}

$("create").onclick = async () => {
  if (!wallet || !provider) { alert("اول کیف را وصل کنید."); return; }
  const name = $("name").value.trim();
  const symbol = $("symbol").value.trim();
  const decimals = Math.max(0,Math.min(9,parseInt($("decimals").value||"9",10)));
  const supply = Number($("supply").value||"0");

  if (!name || !symbol || !(supply>0)) { alert("مقادیر را درست وارد کنید."); return; }

  try {
    status.textContent = "در حال ساخت Mint…";
    const signer = {
      publicKey: new PublicKey(wallet),
      signTransaction: (tx)=>provider.signTransaction(tx),
      signAllTransactions: (txs)=>provider.signAllTransactions(txs)
    };
    // 1) ایجاد Mint
    const mintPk = await spl.createMint(
      connection, signer,
      new PublicKey(wallet), new PublicKey(wallet),
      decimals, undefined, undefined, spl.TOKEN_PROGRAM_ID
    );

    // 2) حساب توکن مرتبط
    status.textContent = "ساخت حساب توکن…";
    const ata = await spl.getOrCreateAssociatedTokenAccount(
      connection, signer, mintPk, new PublicKey(wallet)
    );

    // 3) مینت اولیه
    status.textContent = "مینت عرضه اولیه…";
    const amount = Math.round(supply * 10**decimals);
    const sig = await spl.mintTo(connection, signer, mintPk, ata.address, new PublicKey(wallet), amount);

    const cluster = network==="devnet" ? "devnet" : "";
    const mintUrl = `https://explorer.solana.com/address/${mintPk.toBase58()}?cluster=${cluster}`;
    const txUrl = `https://explorer.solana.com/tx/${sig}?cluster=${cluster}`;
    out.style.display="block";
    out.innerHTML = `
      <div><b>Mint:</b> <div class="code">${mintPk.toBase58()}</div></div>
      <div class="row">
        <a class="code" target="_blank" href="${mintUrl}" style="flex:1;text-align:center">Explorer</a>
        <a class="code" target="_blank" href="${txUrl}" style="flex:1;text-align:center">Transaction</a>
      </div>`;
    status.textContent = "تمام شد ✅";
  } catch (e) {
    console.error(e);
    status.textContent = "خطا: " + (e?.message||e);
  }
};

/* پاک‌سازی کش/سرویس‌ورکر قدیمی */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
  if (window.caches) caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
}
</script>
</body>
</html>
