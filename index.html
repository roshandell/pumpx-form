<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PumpX • Token Creator Pro (No-Build + IPFS + Metadata)</title>
  <link rel="preconnect" href="https://esm.sh"/>
  <style>
    :root{--bg:#0b0f1a;--card:#0f1524;--line:#23304c}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,"Noto Sans Arabic",sans-serif;background:var(--bg);color:#fff}
    .wrap{max-width:1100px;margin:auto;padding:22px}
    .nav{position:sticky;top:0;z-index:40;background:#0b0f1acc;border-bottom:1px solid #ffffff18;backdrop-filter:blur(10px)}
    .navin{display:flex;justify-content:space-between;align-items:center;height:64px}
    .btn{background:linear-gradient(90deg,#12f0ff44,#7a5cff33,#ff3ef633);border:1px solid #ffffff22;padding:10px 14px;border-radius:12px;color:#fff;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .select,.input{background:#121a2c;border:1px solid var(--line);color:#fff;border-radius:12px;padding:10px 12px}
    .card{background:#0f1524cc;border:1px solid #ffffff22;border-radius:18px;padding:16px;box-shadow:0 10px 40px #0006;margin-top:16px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{opacity:.8;font-size:13px}
    .result{word-break:break-all}
    a{color:#79d9ff}
  </style>
</head>
<body>
<div class="nav"><div class="wrap navin">
  <div style="font-weight:900;letter-spacing:.12em">PumpX • Token Creator Pro</div>
  <div class="row">
    <select id="network" class="select">
      <option value="devnet" selected>Devnet</option>
      <option value="mainnet-beta">Mainnet</option>
    </select>
    <button id="connect" class="btn">اتصال Phantom</button>
  </div>
</div></div>

<div class="wrap">
  <section class="card">
    <h2 style="margin:0 0 10px">1) تنظیمات و متادیتا</h2>
    <div class="grid">
      <label>نام (روی‌چین) <input id="name" class="input" value="PumpX Token Pro"></label>
      <label>نماد <input id="symbol" class="input" value="PXP"></label>
      <label>Decimals <input id="decimals" class="input" type="number" min="0" max="9" value="9"></label>
      <label>عرضه اولیه (به واحد انسانی) <input id="supply" class="input" type="number" value="1000000"></label>
      <label>آیکون (PNG/SVG/JPG) <input id="icon" class="input" type="file" accept=".png,.svg,.jpg,.jpeg"/></label>
      <label>API Token (NFT.Storage) <input id="nftkey" class="input" placeholder="paste your API token"/></label>
      <label class="muted" style="grid-column:1/-1">داستان برند (اختیاری)
        <input id="story" class="input" placeholder="یک جمله جذاب برای صفحه توکن"/>
      </label>
    </div>
    <div class="muted" style="margin-top:8px">
      نکته: برای ثبت متادیتا روی‌چین باید <b>URI</b> معتبر (ipfs://...) داشته باشیم. با وارد کردن توکن NFT.Storage، تصویر و JSON روی IPFS آپلود می‌شود.
      اگر API Token خالی باشد، فقط Mint ساخته و عرضه اولیه مینت می‌شود.
    </div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 10px">2) ساخت توکن و ثبت متادیتا</h2>
    <div class="row">
      <button class="btn" id="create" disabled>ساخت توکن + آپلود IPFS + Metadata</button>
      <button class="btn" id="lock" disabled>قفل کردن Mint Authority</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="out" class="card result" style="display:none;margin-top:12px"></div>
    <div id="mobileHelp" class="card" style="display:none;margin-top:12px">
      <div class="row">
        <a id="openPhantom" class="btn" target="_blank">Open in Phantom</a>
        <a class="btn" href="https://phantom.app/download" target="_blank">نصب Phantom</a>
        <span class="muted">برای موبایل، صفحه را داخل اپ Phantom باز کن.</span>
      </div>
    </div>
  </section>
</div>

<script type="module">
/* --- Imports (ESM) --- */
import { Connection, clusterApiUrl, PublicKey } from "https://esm.sh/@solana/web3.js@1.95.3";
import { createMint, getOrCreateAssociatedTokenAccount, mintTo, setAuthority, AuthorityType, TOKEN_PROGRAM_ID } from "https://esm.sh/@solana/spl-token@0.4.6?bundle";
import { createUmi } from "https://esm.sh/@metaplex-foundation/umi-bundle-defaults@0.8.10";
import { publicKey as umiPk, signerIdentity } from "https://esm.sh/@metaplex-foundation/umi@0.8.10";
import { createV1 } from "https://esm.sh/@metaplex-foundation/mpl-token-metadata@3.1.2";

/* --- DOM helpers --- */
const $ = (id)=>document.getElementById(id);
const statusEl=$("status"), out=$("out"), mobileHelp=$("mobileHelp");
const connectBtn=$("connect"), createBtn=$("create"), lockBtn=$("lock"), netSel=$("network");
const openPhantom=$("openPhantom");

/* --- State --- */
let provider=null, wallet=null, network="devnet";
let connection = new Connection(clusterApiUrl(network), "confirmed");
let lastMint=null;

/* --- Utils --- */
const setStatus = (t)=> statusEl.textContent = t || "";
const getProvider = ()=>{
  const w=window;
  if (w?.phantom?.solana?.isPhantom) return w.phantom.solana;
  if (w?.solana?.isPhantom) return w.solana;
  return null;
};
const phantomOpenLink = (url)=> `https://phantom.app/ul/browse?url=${encodeURIComponent(url)}`;
function showMobile(){
  mobileHelp.style.display="block";
  openPhantom.href = phantomOpenLink(location.href.split("#")[0]);
}

/* --- Network switcher --- */
netSel.addEventListener("change", e=>{
  network=e.target.value;
  connection = new Connection(clusterApiUrl(network), "confirmed");
});

/* --- Connect flow --- */
async function tryConnect(onlyIfTrusted=false){
  provider = getProvider();
  if(!provider){
    setStatus("Phantom شناسایی نشد.");
    if(/Mobi|Android|iPhone/i.test(navigator.userAgent)) showMobile();
    return false;
  }
  try{
    const resp = await provider.connect(onlyIfTrusted?{onlyIfTrusted:true}:{});
    wallet = new PublicKey(resp.publicKey.toString());
    connectBtn.textContent = `متصل: ${wallet.toBase58().slice(0,4)}…${wallet.toBase58().slice(-4)}`;
    createBtn.disabled = false;
    setStatus("");
    mobileHelp.style.display="none";
    return true;
  }catch(e){
    setStatus(e?.message||"اتصال لغو شد");
    return false;
  }
}

connectBtn.addEventListener("click", async ()=>{
  if (!getProvider() && !/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
    window.open("https://phantom.app/download","_blank"); return;
  }
  await tryConnect(false);
});

document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState==="visible" && !wallet) tryConnect(true);
});

window.addEventListener("load", async ()=>{
  await new Promise(r=>setTimeout(r,300));
  await tryConnect(true);
  if(!getProvider() && /Mobi|Android|iPhone/i.test(navigator.userAgent)) showMobile();
});

/* --- NFT.Storage upload helpers --- */
async function uploadToNFTStorage(fileOrBlob, apiToken){
  const r = await fetch("https://api.nft.storage/upload", {
    method:"POST",
    headers: { "Authorization":"Bearer "+apiToken },
    body: fileOrBlob
  });
  if(!r.ok) throw new Error("NFT.Storage upload failed");
  const j = await r.json();
  if(!j.ok || !j.value || !j.value.cid) throw new Error("Invalid upload response");
  return "ipfs://"+j.value.cid;
}

/* --- Create token + metadata --- */
createBtn.addEventListener("click", async ()=>{
  if(!wallet || !provider) return alert("ابتدا به Phantom وصل شوید.");

  const name = $("name").value.trim();
  const symbol = $("symbol").value.trim();
  const decimals = Math.max(0, Math.min(9, parseInt($("decimals").value||"9",10)));
  const supplyHuman = Number($("supply").value||"0");
  const story = $("story").value.trim();
  const iconFile = $("icon").files[0] || null;
  const nftKey = $("nftkey").value.trim();

  if(!(supplyHuman>0)) return alert("عرضه اولیه معتبر نیست.");

  try{
    setStatus("ایجاد Mint…");
    const signer = {
      publicKey: wallet,
      signTransaction: (tx)=> provider.signTransaction(tx),
      signAllTransactions: (txs)=> provider.signAllTransactions(txs)
    };
    const mintPk = await createMint(connection, signer, wallet, wallet, decimals, undefined, undefined, TOKEN_PROGRAM_ID);

    setStatus("ساخت حساب توکن (ATA)...");
    const ata = await getOrCreateAssociatedTokenAccount(connection, signer, mintPk, wallet);

    setStatus("مینت عرضه اولیه…");
    const amount = Math.round(supplyHuman * 10**decimals);
    const sigMint = await mintTo(connection, signer, mintPk, ata.address, wallet, amount);

    let metaUri = "";
    if(nftKey){
      // Upload icon (optional)
      let imageUri = "";
      if(iconFile){
        setStatus("آپلود آیکون روی IPFS…");
        imageUri = await uploadToNFTStorage(iconFile, nftKey);
      }
      // Upload JSON metadata
      setStatus("آپلود JSON متادیتا روی IPFS…");
      const meta = {
        name, symbol,
        description: story || `Token ${name} created via PumpX`,
        image: imageUri || undefined,
        attributes: [{trait_type:"creator", value: wallet.toBase58()}]
      };
      const blob = new Blob([JSON.stringify(meta)], {type:"application/json"});
      metaUri = await uploadToNFTStorage(blob, nftKey);

      // Register on-chain Metadata with Metaplex
      setStatus("ثبت Token Metadata روی‌چین…");
      const umi = createUmi(clusterApiUrl(network));
      umi.use(signerIdentity({
        publicKey: umiPk(wallet.toBase58()),
        signTransaction: async (tx)=> provider.signTransaction(tx),
        signAllTransactions: async (txs)=> provider.signAllTransactions(txs)
      }));
      const txMeta = await createV1(umi, {
        mint: umiPk(mintPk.toBase58()),
        authority: umiPk(wallet.toBase58()),
        payer: umiPk(wallet.toBase58()),
        updateAuthority: umiPk(wallet.toBase58()),
        name, symbol, uri: metaUri,
        sellerFeeBasisPoints: 0
      }).sendAndConfirm(umi);

      setStatus("تمام شد ✅");
      lastMint = mintPk;
      lockBtn.disabled = false;

      out.style.display="block";
      out.innerHTML = `
        <div><b>Mint:</b> <code>${mintPk.toBase58()}</code></div>
        <div><b>Metadata URI:</b> <code>${metaUri}</code></div>
        <div>
          <a target="_blank" href="https://explorer.solana.com/address/${mintPk.toBase58()}?cluster=${network==="devnet"?"devnet":""}">مشاهده Mint</a> •
          <a target="_blank" href="https://explorer.solana.com/tx/${sigMint}?cluster=${network==="devnet"?"devnet":""}">تراکنش مینت</a>
        </div>`;
    } else {
      setStatus("تمام شد (بدون Metadata) ✅ — برای ثبت متادیتا، API Token وارد کن");
      lastMint = mintPk;
      lockBtn.disabled = false;
      out.style.display="block";
      out.innerHTML = `
        <div><b>Mint:</b> <code>${mintPk.toBase58()}</code></div>
        <div>
          <a target="_blank" href="https://explorer.solana.com/address/${mintPk.toBase58()}?cluster=${network==="devnet"?"devnet":""}">مشاهده Mint</a> •
          <a target="_blank" href="https://explorer.solana.com/tx/${sigMint}?cluster=${network==="devnet"?"devnet":""}">تراکنش مینت</a>
        </div>
        <div class="muted" style="margin-top:6px">برای متادیتا، آیکون انتخاب کن و توکن NFT.Storage را وارد کن، سپس دوباره اجرا کن.</div>`;
    }
  }catch(e){
    console.error(e);
    setStatus("خطا"); alert(e?.message||e);
  }
});

/* --- Lock mint authority (optional trust) --- */
lockBtn.addEventListener("click", async ()=>{
  if(!lastMint) return;
  try{
    setStatus("قفل‌کردن mint authority…");
    const signer = { publicKey: wallet, signTransaction:(tx)=>provider.signTransaction(tx), signAllTransactions:(txs)=>provider.signAllTransactions(txs) };
    await setAuthority(connection, signer, lastMint, wallet, AuthorityType.MintTokens, null);
    setStatus("Mint قفل شد 🔒");
  }catch(e){
    console.error(e); setStatus("خطا در قفل"); alert(e?.message||e);
  }
});
</script>
</body>
</html>
