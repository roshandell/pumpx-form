<script type="module">
// ... بالای فایل همان است ...

// 1) لیست RPCهای جایگزین برای هر شبکه
const RPCS = {
  "devnet": [
    clusterApiUrl("devnet"),
    "https://api.devnet.solana.com",
    "https://devnet.rpcpool.com"
  ],
  "mainnet-beta": [
    clusterApiUrl("mainnet-beta"),
    "https://api.mainnet-beta.solana.com",
    "https://rpc.ankr.com/solana" // عمومی و پایدار
  ]
};

// 2) تابع امنِ دریافت موجودی با چند RPC
async function safeGetBalance(pubkeyBase58, net){
  const pks = new PublicKey(pubkeyBase58);
  let lastErr = null;
  for (const url of RPCS[net] || []) {
    try {
      const conn = new Connection(url, "confirmed");
      const lamports = await conn.getBalance(pks);
      return lamports; // موفق
    } catch (e) {
      lastErr = e;
      // ادامه بده و بعدی را امتحان کن
    }
  }
  throw lastErr || new Error("RPCs unavailable");
}

// 3) جایگزینِ تابع refreshBalance قبلی
async function refreshBalance(){
  if (!walletPubkey) { balEl.textContent = "—"; return; }
  balEl.textContent = "در حال خواندن…";
  try {
    const lamports = await safeGetBalance(walletPubkey, network);
    balEl.textContent = (lamports / 1e9).toFixed(6);
  } catch (e) {
    balEl.textContent = "خطا";
    console.error("Balance error:", e);
    // پیام دوستانه برای دو خطای رایج:
    if (String(e).includes("rate") || String(e).includes("429")) {
      setStatus("RPC شلوغ است؛ دوباره امتحان کن یا شبکه را جابه‌جا کن.");
    } else {
      setStatus("شبکهٔ کیف را با انتخاب صفحه یکی کن (Devnet/Mainnet).");
    }
  }
}

// 4) وقتی شبکه عوض شد، connection و موجودی را رفرش کن
netSel.addEventListener("change", async e=>{
  network = e.target.value;
  connection = new Connection(RPCS[network][0], "confirmed"); // اولین RPC لیست
  await refreshBalance();
});

// 5) بعد از اتصال کیف، refreshBalance صدا زده شود (در کد اتصال شما همین را اضافه کنید)
// await refreshBalance();
</script>
